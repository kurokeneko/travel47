<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>47éƒ½é“åºœçœŒåˆ¶è¦‡ãƒãƒƒãƒ—ï¼ˆv0.1ï¼‰</title>
<meta name="theme-color" content="#43a047" />
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:%2247%E9%83%BD%E9%81%93%E5%BA%9C%E7%9C%8C%E5%88%B6%E8%A6%87%E3%83%9E%E3%83%83%E3%83%97%22,%22short_name%22:%22%E5%88%B6%E8%A6%87%E3%83%9E%E3%83%83%E3%83%97%22,%22display%22:%22standalone%22,%22start_url%22:%22.%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#43a047%22,%22icons%22:[]}" />
<style>
  :root {
    --green:#43a047;
    --green-ink:#2e7d32;
    --bg:#f7faf7;
    --chip:#e8f5e9;
    --ink:#222;
    --muted:#687076;
    --visited:#81c784;
    --highlight:#ffecb3;
    --unvisited:#e0e0e0;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{
    position:sticky;top:0;z-index:5;
    background:#fff;border-bottom:1px solid #eee;
    padding:12px 16px;display:flex;align-items:center;gap:12px
  }
  .dot{width:10px;height:10px;border-radius:50%;background:var(--green)}
  h1{font-size:18px;margin:0;color:var(--green-ink)}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .panel{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px 12px}
  .stats{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 4px}
  .chip{background:var(--chip);border:1px solid #dbe7dc;color:var(--green-ink);padding:6px 10px;border-radius:999px;font-weight:600}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  button{
    appearance:none;border:0;border-radius:10px;padding:10px 14px;
    background:var(--green);color:#fff;font-weight:700;letter-spacing:.02em
  }
  button.ghost{background:#fff;color:var(--green-ink);border:1px solid #c8e6c9}
  button:disabled{opacity:.55}
  .hint{color:var(--muted);font-size:13px}
  .mapShell{background:#fff;border:1px solid #eee;border-radius:12px;padding:8px}
  .grid{
    display:grid;
    grid-template-columns:repeat(10,minmax(0,1fr));
    gap:4px;
  }
  .pref{
    position:relative;aspect-ratio:1/1;border-radius:8px;
    background:var(--unvisited);display:flex;align-items:center;justify-content:center;
    font-size:11px;text-align:center;padding:4px;cursor:pointer;border:1px solid #ddd;
    user-select:none;-webkit-tap-highlight-color:transparent;
  }
  .pref.visited{background:var(--visited);border-color:#7cbf80}
  .pref.selected{outline:3px solid var(--highlight)}
  .pref small{display:block;color:#333;font-weight:700;font-size:10px}
  .legend{display:flex;gap:8px;align-items:center;margin-top:8px;color:#333}
  .swatch{width:14px;height:14px;border-radius:4px;border:1px solid #ddd}
  .list{margin-top:12px;font-size:14px}
  .badge{display:inline-block;background:#fff3cd;color:#8a6d3b;border:1px solid #ffe8a1;border-radius:999px;padding:2px 8px;font-size:12px}
  footer{color:var(--muted);font-size:12px;text-align:center;margin:24px 0}
</style>
</head>
<body>
  <header>
    <span class="dot"></span>
    <h1>47éƒ½é“åºœçœŒåˆ¶è¦‡ãƒãƒƒãƒ—</h1>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="stats" id="stats">
        <span class="chip">è¨ªå•æ¸ˆã¿ <b id="visitedCount">0</b> / 47</span>
        <span class="chip">ãƒã‚¤ãƒ³ãƒˆ <b id="points">0</b> pt</span>
        <span class="chip">ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆ <b id="tickets">0</b> æš</span>
      </div>
      <div class="row">
        <button id="drawLots">ğŸ¯ ãã˜ã‚’å¼•ãï¼ˆæœªè¨ªå•ã‹ã‚‰ï¼‰</button>
        <button id="useTicket" class="ghost" disabled>ğŸŸ ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆã‚’ä½¿ã†</button>
        <button id="reset" class="ghost">åˆæœŸåŒ–</button>
      </div>
      <p class="hint">åœ°å›³ï¼ˆå„çœŒãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã§ã€Œè¨ªå•æ¸ˆã¿ã€ã«åˆ‡æ›¿ã€‚10çœŒè¨ªå•ã”ã¨ã«è‡ªå‹•ã§ğŸŸãŒ1æšè²¯ã¾ã‚Šã¾ã™ã€‚<br>
      ğŸŸä½¿ç”¨ä¸­ã¯ä¸€åº¦è¨ªã‚ŒãŸçœŒã‚‚ã€Œç‰¹åˆ¥è¨ªå•ã€å¯èƒ½ï¼ˆè¨ªå•æ•°ã¯å¢—ãˆã¾ã›ã‚“ãŒè¨˜éŒ²ã«æ®‹ã›ã¾ã™ï¼‰ã€‚</p>
    </div>

    <!-- v0.1: ç°¡æ˜“ãƒ–ãƒ­ãƒƒã‚¯æ—¥æœ¬åœ°å›³ï¼ˆæ¦‚ã­åœ°æ–¹ã”ã¨ã«é…ç½®ï¼‰ -->
    <div class="mapShell" aria-label="æ—¥æœ¬åœ°å›³ï¼ˆç°¡æ˜“ãƒ–ãƒ­ãƒƒã‚¯ï¼‰">
      <div class="grid" id="mapGrid"></div>
      <div class="legend">
        <span class="swatch" style="background:var(--unvisited)"></span> æœªè¨ªå•
        <span class="swatch" style="background:var(--visited)"></span> è¨ªå•æ¸ˆã¿
        <span class="swatch" style="outline:3px solid var(--highlight);background:#fff"></span> ãã˜ã®å½“é¸/ç‰¹åˆ¥é¸æŠä¸­
      </div>
      <div class="list" id="logArea"></div>
    </div>

    <footer>v0.1ï¼ˆæ¬¡ã®æ®µéšã§ç²¾å¯†SVGã«å·®ã—æ›¿ãˆ / FirebaseåŒæœŸäºˆå®šï¼‰</footer>
  </div>

<script>
/*
  v0.1 æ–¹é‡
  - 47éƒ½é“åºœçœŒã‚’é…åˆ—åŒ– â†’ ç°¡æ˜“ãƒ–ãƒ­ãƒƒã‚¯SVGï¼ˆ=å®Ÿä½“ã¯CSS Gridã®squareï¼‰ã¨ã—ã¦æç”»
  - ã‚¯ãƒªãƒƒã‚¯ã§ visited toggleã€visitedæ•°=pointsã€è‡ªå‹•ã§ freeTicket = floor(points/10) - used
  - ğŸ¯ãã˜ = æœªè¨ªå•ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 1ä»¶ â†’ ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  - ğŸŸãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆ = æœ‰åŠ¹ä¸­ã¯æ—¢è¨ªå•ã‚‚â€œç‰¹åˆ¥è¨ªå•â€ã¨ã—ã¦è¨˜éŒ²ï¼ˆvisitedå¢—ã‚„ã•ãªã„ï¼‰
  - localStorageã§ä¿å­˜/å¾©å…ƒ
  - v0.2ä»¥é™ã§æœ¬ç‰©ã®åœ°å½¢SVGã«ç½®æ›ï¼ˆIDå¯¾å¿œã¯ç¶­æŒï¼‰
*/

const PREFS = [
  // åŒ—æµ·é“ãƒ»æ±åŒ—
  "åŒ—æµ·é“","é’æ£®","å²©æ‰‹","å®®åŸ","ç§‹ç”°","å±±å½¢","ç¦å³¶",
  // é–¢æ±
  "èŒ¨åŸ","æ ƒæœ¨","ç¾¤é¦¬","åŸ¼ç‰","åƒè‘‰","æ±äº¬","ç¥å¥ˆå·",
  // ä¸­éƒ¨ï¼ˆç”²ä¿¡è¶Šãƒ»åŒ—é™¸ãƒ»æ±æµ·ï¼‰
  "æ–°æ½Ÿ","å¯Œå±±","çŸ³å·","ç¦äº•","å±±æ¢¨","é•·é‡","å²é˜œ","é™å²¡","æ„›çŸ¥",
  // è¿‘ç•¿
  "ä¸‰é‡","æ»‹è³€","äº¬éƒ½","å¤§é˜ª","å…µåº«","å¥ˆè‰¯","å’Œæ­Œå±±",
  // ä¸­å›½
  "é³¥å–","å³¶æ ¹","å²¡å±±","åºƒå³¶","å±±å£",
  // å››å›½
  "å¾³å³¶","é¦™å·","æ„›åª›","é«˜çŸ¥",
  // ä¹å·ãƒ»æ²–ç¸„
  "ç¦å²¡","ä½è³€","é•·å´","ç†Šæœ¬","å¤§åˆ†","å®®å´","é¹¿å…å³¶","æ²–ç¸„"
];

const state = {
  visited: {},      // {çœŒå: true/false}
  specialTrips: [], // ğŸŸä½¿ç”¨ã§ã®â€œç‰¹åˆ¥è¨ªå•â€ãƒ­ã‚° {name, ts}
  usedTickets: 0,   // ä½¿ç”¨æ¸ˆã¿ãƒã‚±ãƒƒãƒˆæšæ•°
  selected: null,   // ãã˜/é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆ
  ticketMode: false // ğŸŸä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰ä¸­
};

const els = {
  grid: document.getElementById("mapGrid"),
  visitedCount: document.getElementById("visitedCount"),
  points: document.getElementById("points"),
  tickets: document.getElementById("tickets"),
  drawLots: document.getElementById("drawLots"),
  useTicket: document.getElementById("useTicket"),
  reset: document.getElementById("reset"),
  logArea: document.getElementById("logArea"),
};

init();

function init(){
  // å¾©å…ƒ
  const saved = JSON.parse(localStorage.getItem("jp47-game")||"{}");
  if(saved.visited) state.visited = saved.visited;
  if(saved.specialTrips) state.specialTrips = saved.specialTrips;
  if(saved.usedTickets!=null) state.usedTickets = saved.usedTickets;

  // ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆï¼ˆ10x?ï¼‰â€” ä½ç½®ã¯â€œã–ã£ãã‚Šåœ°æ–¹é †â€ã«ä¸¦ã¹
  PREFS.forEach((name, i)=>{
    const div = document.createElement("div");
    div.className = "pref";
    div.dataset.name = name;
    div.innerHTML = `<small>${name}</small>`;
    if(state.visited[name]) div.classList.add("visited");
    div.addEventListener("click", ()=> onPrefClick(div));
    els.grid.appendChild(div);
  });

  updateStats();
  els.drawLots.addEventListener("click", onDrawLots);
  els.useTicket.addEventListener("click", onToggleTicketMode);
  els.reset.addEventListener("click", hardReset);

  // PWA: ç°¡æ˜“SWç™»éŒ²ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³èµ·å‹•ã®è¶³ãŒã‹ã‚Šï¼‰
  if('serviceWorker' in navigator){
    const sw = `
      self.addEventListener('install',e=>self.skipWaiting());
      self.addEventListener('activate',e=>self.clients.claim());
      self.addEventListener('fetch',e=>{});
    `;
    const blob = new Blob([sw],{type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url);
  }
}

function onPrefClick(el){
  const name = el.dataset.name;

  if(state.ticketMode){
    // ğŸŸä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢è¨ªå•/æœªè¨ªå•å•ã‚ãšã€Œç‰¹åˆ¥è¨ªå•ã€è¨˜éŒ² â†’ ãƒ¢ãƒ¼ãƒ‰è§£é™¤ & ä½¿ç”¨æšæ•°+1
    if(getTickets()<=0){
      alert("ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“");
      state.ticketMode = false;
      renderTicketButton();
      return;
    }
    state.specialTrips.push({name, ts: Date.now()});
    state.usedTickets += 1;
    state.ticketMode = false;
    renderTicketButton();
    flash(el);
    save(); renderLog(); updateStats();
    return;
  }

  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šä¸€åº¦è¡Œã£ãŸã‚‰åŸå‰‡è¡Œã‘ãªã„ â†’ toggle ã§ã¯ãªã â€œè¨ªå•æ¸ˆã¿ã«å›ºå®šâ€
  if(!state.visited[name]){
    state.visited[name] = true;
    el.classList.add("visited");
    flash(el);
    save(); renderLog(); updateStats();
  } else {
    // æ—¢è¨ªå•ã¯è§¦ã£ã¦ã‚‚çŠ¶æ…‹ã¯å¤‰ãˆãªã„ï¼ˆãƒ«ãƒ¼ãƒ«ï¼šåŸºæœ¬ã¯ä¸€åº¦è¡Œã£ãŸã‚‰è¡Œã‘ãªã„ï¼‰
    wiggle(el);
  }
}

function onDrawLots(){
  const unvisited = PREFS.filter(n=>!state.visited[n]);
  if(unvisited.length===0){
    alert("æœªè¨ªå•ã®çœŒã¯ã‚ã‚Šã¾ã›ã‚“ï¼ãŠã‚ã§ã¨ã†ï¼");
    return;
  }
  const pick = unvisited[Math.floor(Math.random()*unvisited.length)];
  state.selected = pick;

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
  document.querySelectorAll(".pref").forEach(p=>{
    p.classList.toggle("selected", p.dataset.name===pick);
  });

  // å°ã•ãªæ¼”å‡º
  const el = [...document.querySelectorAll(".pref")].find(p=>p.dataset.name===pick);
  if(el) flash(el);
}

function onToggleTicketMode(){
  if(getTickets()<=0 && !state.ticketMode){
    alert("ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚çœŒã‚’10ãƒ¶æ‰€è¨ªå•ã™ã‚‹ã¨1æšè²¯ã¾ã‚Šã¾ã™ã€‚");
    return;
  }
  state.ticketMode = !state.ticketMode;
  renderTicketButton();
  // è¦–è¦šçš„ã«ã€Œå¥½ããªçœŒã‚’é¸ã‚“ã§ãã ã•ã„ã€æ„Ÿã‚’å‡ºã™
  if(state.ticketMode){
    document.querySelectorAll(".pref").forEach(p=>p.classList.add("selected"));
  } else {
    document.querySelectorAll(".pref").forEach(p=>p.classList.remove("selected"));
    if(state.selected){
      const el = [...document.querySelectorAll(".pref")].find(p=>p.dataset.name===state.selected);
      if(el) el.classList.add("selected");
    }
  }
}

function getVisitedCount(){
  return Object.values(state.visited).filter(Boolean).length;
}

function getTickets(){
  // 10çœŒã”ã¨ã«1æš â†’ ç™ºè¡Œæšæ•° = floor(points/10)
  const issued = Math.floor(getVisitedCount()/10);
  return issued - state.usedTickets;
}

function updateStats(){
  const visited = getVisitedCount();
  els.visitedCount.textContent = visited;
  els.points.textContent = visited; // 1çœŒ=1pt
  els.tickets.textContent = getTickets();
  renderTicketButton();
  renderLog();
}

function renderTicketButton(){
  els.useTicket.disabled = getTickets()<=0 && !state.ticketMode;
  els.useTicket.textContent = state.ticketMode ? "âœ… ä½¿ã†ã®ã‚’ã‚„ã‚ã‚‹" : "ğŸŸ ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆã‚’ä½¿ã†";
}

function renderLog(){
  const t = getTickets();
  const used = state.usedTickets;
  const issued = Math.floor(getVisitedCount()/10);
  const logs = [];
  logs.push(`ğŸ“ ãƒ­ã‚°ï¼šãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆç™ºè¡Œ <span class="badge">${issued}æš</span> ï¼ ä½¿ç”¨ <span class="badge">${used}æš</span> ï¼ æ®‹ <span class="badge">${t}æš</span>`);
  if(state.specialTrips.length){
    const items = state.specialTrips.slice().reverse().slice(0,10).map(s=>{
      const d = new Date(s.ts);
      const ds = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
      return `ãƒ»${ds} ç‰¹åˆ¥è¨ªå•ï¼š${s.name}`;
    }).join("<br>");
    logs.push(items);
  } else {
    logs.push(`ãƒ»ã¾ã ç‰¹åˆ¥è¨ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ10çœŒé”æˆã§ğŸŸ1æšï¼‰`);
  }
  els.logArea.innerHTML = logs.join("<br>");
}

function save(){
  localStorage.setItem("jp47-game", JSON.stringify({
    visited: state.visited,
    specialTrips: state.specialTrips,
    usedTickets: state.usedTickets
  }));
}

function hardReset(){
  if(!confirm("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  state.visited = {};
  state.specialTrips = [];
  state.usedTickets = 0;
  state.selected = null;
  state.ticketMode = false;
  document.querySelectorAll(".pref").forEach(p=>{
    p.classList.remove("visited","selected");
  });
  save(); updateStats();
}

function flash(el){
  el.animate([{transform:"scale(1)"},{transform:"scale(1.06)"},{transform:"scale(1)"}],
             {duration:280,easing:"ease-out"});
}
function wiggle(el){
  el.animate([{transform:"translateX(0)"},{transform:"translateX(-3px)"},{transform:"translateX(3px)"},{transform:"translateX(0)"}],
             {duration:280,easing:"ease-out"});
}

// ------ ç°¡æ˜“â€œåœ°å›³â€ã®ä¸¦ã³ï¼ˆåœ°æ–¹ã£ã½ã„é›°å›²æ°—ã§10åˆ—ã«é…ç½®ï¼‰------
// èª¬æ˜ï¼šã“ã“ã¯è¦–è¦šã®é…ç½®ã ã‘ã€‚æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§â€œæœ¬ç‰©ã®SVGåœ°å½¢â€ã«ç½®æ›ã—ã¾ã™ã€‚
(function layout(){
  const cells = Array.from(document.querySelectorAll(".pref"));
  // ã–ã£ãã‚Šåœ°æ–¹ãƒ¬ã‚¤ãƒ¤ï¼šè¡Œã‚’å¤šå°‘ãšã‚‰ã—ã¦â€œæ—¥æœ¬åˆ—å³¶ã½ã•â€ã‚’æ¼”å‡º
  // é…ç½®ã¯æ‰‹è§¦ã‚Šå„ªå…ˆï¼ˆæ­£ç¢ºãªåœ°ç†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
  const order = [
    "åŒ—æµ·é“",
    "é’æ£®","å²©æ‰‹","å®®åŸ","ç§‹ç”°","å±±å½¢","ç¦å³¶",
    "æ–°æ½Ÿ","å¯Œå±±","çŸ³å·","ç¦äº•","å±±æ¢¨","é•·é‡","èŒ¨åŸ","æ ƒæœ¨","ç¾¤é¦¬",
    "åŸ¼ç‰","åƒè‘‰","æ±äº¬","ç¥å¥ˆå·",
    "å²é˜œ","é™å²¡","æ„›çŸ¥","ä¸‰é‡","æ»‹è³€","äº¬éƒ½","å¤§é˜ª","å…µåº«","å¥ˆè‰¯","å’Œæ­Œå±±",
    "é³¥å–","å³¶æ ¹","å²¡å±±","åºƒå³¶","å±±å£",
    "å¾³å³¶","é¦™å·","æ„›åª›","é«˜çŸ¥",
    "ç¦å²¡","ä½è³€","é•·å´","ç†Šæœ¬","å¤§åˆ†","å®®å´","é¹¿å…å³¶","æ²–ç¸„"
  ];
  // ä¸¦ã¹æ›¿ãˆ
  const map = new Map(order.map((n,i)=>[n,i]));
  cells.sort((a,b)=>map.get(a.dataset.name)-map.get(b.dataset.name))
       .forEach(c=>els.grid.appendChild(c));
})();
</script>
</body>
</html>
