<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>47éƒ½é“åºœçœŒåˆ¶è¦‡ãƒãƒƒãƒ—ï¼ˆç²¾å¯†SVGï¼‰</title>
<meta name="theme-color" content="#43a047" />
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:%2247%E9%83%BD%E9%81%93%E5%BA%9C%E7%9C%8C%E5%88%B6%E8%A6%87%E3%83%9E%E3%83%83%E3%83%97%22,%22short_name%22:%22%E5%88%B6%E8%A6%87%E3%83%9E%E3%83%83%E3%83%97%22,%22display%22:%22standalone%22,%22start_url%22:%22.%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#43a047%22}" />
<style>
  :root{
    --green:#43a047; --green-ink:#2e7d32; --bg:#f7faf7; --chip:#e8f5e9;
    --ink:#222; --muted:#687076; --visited:#81c784; --highlight:#ffecb3; --unvisited:#e9ecef; --stroke:#c7c7c7;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--green)}
  h1{font-size:18px;margin:0;color:var(--green-ink)}
  .wrap{max-width:1060px;margin:0 auto;padding:16px}
  .panel{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
  .stats{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 4px}
  .chip{background:var(--chip);border:1px solid #dbe7dc;color:var(--green-ink);padding:6px 10px;border-radius:999px;font-weight:600}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  button{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--green);color:#fff;font-weight:700;letter-spacing:.02em}
  button.ghost{background:#fff;color:var(--green-ink);border:1px solid #c8e6c9}
  button:disabled{opacity:.55}
  .hint{color:var(--muted);font-size:13px}
  .mapShell{background:#fff;border:1px solid #eee;border-radius:12px;padding:8px}
  #mapHost{min-height:320px}
  svg{width:100%;height:auto;max-width:1000px;display:block;margin:0 auto}
  /* ãƒœã‚¿ãƒ³åŒ–ã—ãŸçœŒ */
  .pref{cursor:pointer;fill:var(--unvisited);stroke:var(--stroke);stroke-width:0.6;transition:filter .15s ease}
  .pref:hover{filter:brightness(1.02)}
  .pref.visited{fill:var(--visited)}
  .pref.selected{filter:drop-shadow(0 0 .6rem rgba(255,200,0,.6))}
  .legend{display:flex;gap:8px;align-items:center;margin-top:8px;color:#333;flex-wrap:wrap}
  .swatch{width:14px;height:14px;border-radius:4px;border:1px solid #ddd}
  .list{margin-top:12px;font-size:14px}
  .badge{display:inline-block;background:#fff3cd;color:#8a6d3b;border:1px solid #ffe8a1;border-radius:999px;padding:2px 8px;font-size:12px}
  footer{color:var(--muted);font-size:12px;text-align:center;margin:24px 0}
  .warn{background:#fff8e1;border:1px solid #ffe8a1;color:#6b5b19;padding:8px 10px;border-radius:8px;margin:8px 0}
  
  .pref:focus {
  outline: none;
}
.pref {
  pointer-events: all;
  focusable: false;
}
svg:focus {
  outline: none;
}
  
</style>
</head>
<body>
<header><span class="dot"></span><h1>47éƒ½é“åºœçœŒåˆ¶è¦‡ãƒãƒƒãƒ—ï¼ˆç²¾å¯†SVGï¼‰</h1></header>

<div class="wrap">
  <div class="panel">
    <div class="stats" id="stats">
      <span class="chip">è¨ªå•æ¸ˆã¿ <b id="visitedCount">0</b> / 47</span>
      <span class="chip">ãƒã‚¤ãƒ³ãƒˆ <b id="points">0</b> pt</span>
      <span class="chip">ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆ <b id="tickets">0</b> æš</span>
    </div>
    <div class="row">
      <button id="drawLots">ğŸ¯ ãã˜ã‚’å¼•ãï¼ˆæœªè¨ªå•ã‹ã‚‰ï¼‰</button>
      <button id="useTicket" class="ghost" disabled>ğŸŸ ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆã‚’ä½¿ã†</button>
      <button id="reset" class="ghost">åˆæœŸåŒ–</button>
    </div>
    <p class="hint">çœŒã‚’ã‚¿ãƒƒãƒ—ã§è¨ªå•æ¸ˆã¿ã«ã€‚10çœŒã”ã¨ã«ğŸŸ1æšã€‚ğŸŸä¸­ã¯æ—¢è¨ªå•ã‚‚ã€Œç‰¹åˆ¥è¨ªå•ã€è¨˜éŒ²ã€‚</p>
    <div id="msg" class="warn" style="display:none;"></div>
  </div>

  <div class="mapShell" aria-label="æ—¥æœ¬åœ°å›³ï¼ˆç²¾å¯†SVGï¼‰">
    <!-- ã“ã“ã«å¤–éƒ¨SVGã‚’èª­ã¿è¾¼ã‚“ã§æŒ¿å…¥ -->
    <div id="mapHost" aria-busy="true" aria-label="æ—¥æœ¬åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦"></div>

    <div class="legend">
      <span class="swatch" style="background:var(--unvisited)"></span> æœªè¨ªå•
      <span class="swatch" style="background:var(--visited)"></span> è¨ªå•æ¸ˆã¿
      <span class="swatch" style="outline:3px solid var(--highlight);background:#fff"></span> ãã˜å½“é¸/ç‰¹åˆ¥é¸æŠä¸­
    </div>
    <div class="list" id="logArea"></div>
  </div>

  <footer>åœ°å›³ã¯ Geolonia ã®ç²¾å¯†SVGã‚’åˆ©ç”¨ï¼ˆå„çœŒã« data-code ã‚’ä»˜ä¸ï¼‰ [oai_citation:1â€¡GitHub](https://github.com/geolonia/japanese-prefectures)</footer>
</div>

<script>
/* ========= åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ ========= */
const PREFS = ["åŒ—æµ·é“","é’æ£®","å²©æ‰‹","å®®åŸ","ç§‹ç”°","å±±å½¢","ç¦å³¶",
  "èŒ¨åŸ","æ ƒæœ¨","ç¾¤é¦¬","åŸ¼ç‰","åƒè‘‰","æ±äº¬","ç¥å¥ˆå·",
  "æ–°æ½Ÿ","å¯Œå±±","çŸ³å·","ç¦äº•","å±±æ¢¨","é•·é‡","å²é˜œ","é™å²¡","æ„›çŸ¥",
  "ä¸‰é‡","æ»‹è³€","äº¬éƒ½","å¤§é˜ª","å…µåº«","å¥ˆè‰¯","å’Œæ­Œå±±",
  "é³¥å–","å³¶æ ¹","å²¡å±±","åºƒå³¶","å±±å£",
  "å¾³å³¶","é¦™å·","æ„›åª›","é«˜çŸ¥",
  "ç¦å²¡","ä½è³€","é•·å´","ç†Šæœ¬","å¤§åˆ†","å®®å´","é¹¿å…å³¶","æ²–ç¸„"];

const CODE_TO_NAME = {
 "01":"åŒ—æµ·é“","02":"é’æ£®","03":"å²©æ‰‹","04":"å®®åŸ","05":"ç§‹ç”°","06":"å±±å½¢","07":"ç¦å³¶",
 "08":"èŒ¨åŸ","09":"æ ƒæœ¨","10":"ç¾¤é¦¬","11":"åŸ¼ç‰","12":"åƒè‘‰","13":"æ±äº¬","14":"ç¥å¥ˆå·",
 "15":"æ–°æ½Ÿ","16":"å¯Œå±±","17":"çŸ³å·","18":"ç¦äº•","19":"å±±æ¢¨","20":"é•·é‡","21":"å²é˜œ","22":"é™å²¡","23":"æ„›çŸ¥",
 "24":"ä¸‰é‡","25":"æ»‹è³€","26":"äº¬éƒ½","27":"å¤§é˜ª","28":"å…µåº«","29":"å¥ˆè‰¯","30":"å’Œæ­Œå±±",
 "31":"é³¥å–","32":"å³¶æ ¹","33":"å²¡å±±","34":"åºƒå³¶","35":"å±±å£",
 "36":"å¾³å³¶","37":"é¦™å·","38":"æ„›åª›","39":"é«˜çŸ¥",
 "40":"ç¦å²¡","41":"ä½è³€","42":"é•·å´","43":"ç†Šæœ¬","44":"å¤§åˆ†","45":"å®®å´","46":"é¹¿å…å³¶","47":"æ²–ç¸„"
};

/* ========= çŠ¶æ…‹ ========= */
const state = { visited:{}, specialTrips:[], usedTickets:0, selected:null, ticketMode:false };
const els = {
  host:document.getElementById("mapHost"),
  msg:document.getElementById("msg"),
  visitedCount:document.getElementById("visitedCount"),
  points:document.getElementById("points"),
  tickets:document.getElementById("tickets"),
  drawLots:document.getElementById("drawLots"),
  useTicket:document.getElementById("useTicket"),
  reset:document.getElementById("reset"),
  logArea:document.getElementById("logArea"),
};

init();

/* ========= åˆæœŸåŒ– ========= */
async function init(){
  // ä¿å­˜å¾©å…ƒ
  const saved = JSON.parse(localStorage.getItem("jp47-game")||"{}");
  if(saved.visited) state.visited = saved.visited;
  if(saved.specialTrips) state.specialTrips = saved.specialTrips;
  if(saved.usedTickets!=null) state.usedTickets = saved.usedTickets;

  // åœ°å›³èª­ã¿è¾¼ã¿ï¼ˆå¤–éƒ¨â†’ãƒ­ãƒ¼ã‚«ãƒ«ã®é †ã«è©¦è¡Œï¼‰
  await loadSvgMap();

  // UIã‚¤ãƒ™ãƒ³ãƒˆ
  els.drawLots.addEventListener("click", onDrawLots);
  els.useTicket.addEventListener("click", onToggleTicketMode);
  els.reset.addEventListener("click", hardReset);

  // PWAï¼ˆç°¡æ˜“SWï¼‰
  if('serviceWorker' in navigator){
    const sw = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('fetch',e=>{});`;
    const url = URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
    navigator.serviceWorker.register(url);
  }

  updateStats();
}

/* ========= ç²¾å¯†ç™½åœ°å›³ã®èª­ã¿è¾¼ã¿ï¼†ãƒœã‚¿ãƒ³åŒ– ========= */
async function loadSvgMap(){
  // 1) ã¾ãšã¯ Geolonia ã®å…¬é–‹SVGï¼ˆmap-full.svgï¼‰ã‚’å–å¾—
  //    å¤±æ•—ã—ãŸã‚‰ 2) /assets/map-full.svg ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¾Œè¿°ï¼‰
  const urls = [
    "https://geolonia.github.io/japanese-prefectures/map-full.svg",
    "./assets/map-full.svg" // â† å¤±æ•—æ™‚ã¯ã“ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’ä½¿ã†ï¼ˆå¿…è¦ãªã‚‰ç”¨æ„ã™ã‚‹ï¼‰
  ];

  let svgText = null, lastErr = null;
  for(const url of urls){
    try{
      const res = await fetch(url, {mode:"cors"});
      if(!res.ok) throw new Error(String(res.status));
      svgText = await res.text();
      break;
    }catch(e){ lastErr = e; }
  }
  if(!svgText){
    showMsg("ç™½åœ°å›³ï¼ˆSVGï¼‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã™ã‚‹ã‹ã€`/assets/map-full.svg` ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚");
    els.host.removeAttribute("aria-busy");
    return;
  }

  // å·®ã—è¾¼ã¿
  els.host.innerHTML = svgText;
  els.host.removeAttribute("aria-busy");

  // ãƒ«ãƒ¼ãƒˆSVGã« id ã‚’ä»˜ä¸ï¼ˆãªã‘ã‚Œã°ï¼‰
  const svg = els.host.querySelector("svg");
  if(svg && !svg.id) svg.id = "japanMap";

  // Geoloniaã®ä»•æ§˜ï¼šå„çœŒã¯ .prefecture ã‚¯ãƒ©ã‚¹ã€data-code="01" ç­‰ãŒä»˜ã„ã¦ã„ã‚‹ï¼ˆREADMEã®ä»•æ§˜ï¼‰ [oai_citation:2â€¡GitHub](https://github.com/geolonia/japanese-prefectures)
  // ãã‚Œã‚’ã“ã®ã‚¢ãƒ—ãƒªç”¨ã« .pref & data-name="çœŒå" ã«â€œã‚¢ãƒ€ãƒ—ãƒˆâ€ã™ã‚‹
  adaptSvgAsButtons(svg);

  // æ—¢è¨ªå•ã®å¾©å…ƒ & ã‚¯ãƒªãƒƒã‚¯ã‚’ä»˜ä¸
  bindSvgEvents();
}

/* ã©ã‚“ãªç™½åœ°å›³ã§ã‚‚ â€œpref ãƒœã‚¿ãƒ³â€ ã«å¤‰æ› */
function adaptSvgAsButtons(svgEl){
  if(!svgEl) return;

  // 1) Geolonia: data-code ã‚’çœŒåã¸å¤‰æ›
  svgEl.querySelectorAll("[data-code]").forEach(el=>{
    const code = String(el.getAttribute("data-code")).padStart(2,"0");
    const name = CODE_TO_NAME[code];
    if(!name) return;
    el.classList.add("pref");
    el.setAttribute("data-name", name);
  });

  // 2) å¿µã®ãŸã‚ path/g ã«çœŒåãŒå«ã¾ã‚Œã¦ã„ã‚Œã°è£œå®Œï¼ˆWikimediaç­‰ã®åˆ¥SVGã§ã‚‚å‹•ãï¼‰
  svgEl.querySelectorAll("path, g").forEach(el=>{
    if(el.classList.contains("pref")) return;
    const id = el.getAttribute("id") || "";
    const title = el.querySelector("title")?.textContent || "";
    const guess = PREFS.find(n => id.includes(n) || title.includes(n));
    if(guess){
      el.classList.add("pref");
      el.setAttribute("data-name", guess);
    }
  });
}

/* ========= çœŒã‚¯ãƒªãƒƒã‚¯ã®ãƒãƒ³ãƒ‰ãƒ©ç­‰ ========= */
function bindSvgEvents(){
  const paths = document.querySelectorAll(".pref");
  paths.forEach(p=>{
    const name = p.getAttribute("data-name");
    if(!name) return;
    if(state.visited[name]) p.classList.add("visited");
    p.addEventListener("click", ()=>onPrefClick(p));
  });
}

function onPrefClick(el){
  el.blur?.();
  const name = el.getAttribute("data-name");
  if(!name) return;

  if(state.ticketMode){
    if(getTickets()<=0){ alert("ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“"); state.ticketMode=false; renderTicketButton(); return; }
    state.specialTrips.push({name, ts:Date.now()});
    state.usedTickets += 1; state.ticketMode=false; renderTicketButton(); flash(el);
    save(); renderLog(); updateStats(); return;
  }
  if(!state.visited[name]){
    state.visited[name] = true; el.classList.add("visited"); flash(el);
    save(); renderLog(); updateStats();
  } else { wiggle(el); }
}

function onDrawLots(){
  const unvisited = PREFS.filter(n=>!state.visited[n]);
  if(unvisited.length===0){ alert("æœªè¨ªå•ã®çœŒã¯ã‚ã‚Šã¾ã›ã‚“ï¼åˆ¶è¦‡ãŠã‚ã§ã¨ã†ï¼"); return; }
  const pick = unvisited[Math.floor(Math.random()*unvisited.length)];
  state.selected = pick;
  document.querySelectorAll(".pref").forEach(p=>{
    p.classList.toggle("selected", p.getAttribute("data-name")===pick);
  });
  const el = [...document.querySelectorAll(".pref")].find(p=>p.getAttribute("data-name")===pick);
  if(el) flash(el);
}

function onToggleTicketMode(){
  if(getTickets()<=0 && !state.ticketMode){ alert("ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚10çœŒé”æˆã§1æšä»˜ä¸ã€‚"); return; }
  state.ticketMode = !state.ticketMode; renderTicketButton();
  document.querySelectorAll(".pref").forEach(p=>{
    p.classList.toggle("selected", state.ticketMode || p.getAttribute("data-name")===state.selected);
  });
}

/* ========= ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ & ä¿å­˜ ========= */
function getVisitedCount(){ return Object.values(state.visited).filter(Boolean).length; }
function getTickets(){ const issued = Math.floor(getVisitedCount()/10); return issued - state.usedTickets; }

function updateStats(){
  const visited = getVisitedCount();
  document.getElementById("visitedCount").textContent = visited;
  document.getElementById("points").textContent = visited;
  document.getElementById("tickets").textContent = getTickets();
  renderTicketButton(); renderLog();
}
function renderTicketButton(){
  const btn = document.getElementById("useTicket");
  btn.disabled = getTickets()<=0 && !state.ticketMode;
  btn.textContent = state.ticketMode ? "âœ… ä½¿ã†ã®ã‚’ã‚„ã‚ã‚‹" : "ğŸŸ ãƒ•ãƒªãƒ¼ãƒã‚±ãƒƒãƒˆã‚’ä½¿ã†";
}
function renderLog(){
  const t = getTickets(), used = state.usedTickets, issued = Math.floor(getVisitedCount()/10);
  const logs = [];
  logs.push(`ğŸ“ ãƒ­ã‚°ï¼šç™ºè¡Œ <span class="badge">${issued}æš</span> ï¼ ä½¿ç”¨ <span class="badge">${used}æš</span> ï¼ æ®‹ <span class="badge">${t}æš</span>`);
  if(state.specialTrips.length){
    const items = state.specialTrips.slice().reverse().slice(0,10).map(s=>{
      const d = new Date(s.ts);
      const ds = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
      return `ãƒ»${ds} ç‰¹åˆ¥è¨ªå•ï¼š${s.name}`;
    }).join("<br>");
    logs.push(items);
  } else { logs.push(`ãƒ»ã¾ã ç‰¹åˆ¥è¨ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ10çœŒé”æˆã§ğŸŸ1æšï¼‰`); }
  els.logArea.innerHTML = logs.join("<br>");
}
function save(){
  localStorage.setItem("jp47-game", JSON.stringify({
    visited:state.visited, specialTrips:state.specialTrips, usedTickets:state.usedTickets
  }));
}

/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
function hardReset(){
  if(!confirm("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  state.visited = {}; state.specialTrips = []; state.usedTickets = 0; state.selected = null; state.ticketMode = false;
  document.querySelectorAll(".pref").forEach(p=>p.classList.remove("visited","selected"));
  save(); updateStats();
}
function flash(el){ el.animate([{transform:"scale(1)"},{transform:"scale(1.06)"},{transform:"scale(1)"}],{duration:280,easing:"ease-out"}); }
function wiggle(el){ el.animate([{transform:"translateX(0)"},{transform:"translateX(-3px)"},{transform:"translateX(3px)"},{transform:"translateX(0)"}],{duration:280,easing:"ease-out"}); }
function showMsg(t){ els.msg.textContent=t; els.msg.style.display="block"; }
</script>
</body>
</html>